---
title: "R Notebook"
output: html_notebook
---

```{r}
library(mvtnorm)
```


getting the data
```{r}
env_lat<-data.matrix(read.table("depo_latemar.txt"))
diag_lat<-data.matrix(read.table("diag_latemar.txt"))
nz=nrow(env_lat)
nz
```

transforming into indicators
```{r}
e1<-e2<-e3<-e4<-d1<-d2<-d3<-matrix(0,nz,4)
e1[env_lat==1]=1
e2[env_lat==2]=1
e3[env_lat==3]=1
e4[env_lat==4]=1
d1[diag_lat==1]=1
d2[diag_lat==2]=1
d3[diag_lat==3]=1
e1[is.na(env_lat)]=e2[is.na(env_lat)]=e3[is.na(env_lat)]=e4[is.na(env_lat)]=NA
d1[is.na(diag_lat)]=d2[is.na(diag_lat)]=d3[is.na(diag_lat)]=NA
```

```{r}
source("cosim_functions.R")
```

computing transiograms between different facies
the environment of depositions
```{r, fig.height=6, fig.width=8}
par(mfrow=c(4,4))
tr_2d_vert(e1,e1,30,nz,0.1)
tr_2d_vert(e1,e2,30,nz,0.1)
tr_2d_vert(e1,e3,30,nz,0.1)
tr_2d_vert(e1,e4,30,nz,0.1)
tr_2d_vert(e2,e1,30,nz,0.1)
tr_2d_vert(e2,e2,30,nz,0.1)
tr_2d_vert(e2,e3,30,nz,0.1)
tr_2d_vert(e2,e4,30,nz,0.1)
tr_2d_vert(e3,e1,30,nz,0.1)
tr_2d_vert(e3,e2,30,nz,0.1)
tr_2d_vert(e3,e3,30,nz,0.1)
tr_2d_vert(e3,e4,30,nz,0.1)
tr_2d_vert(e4,e1,30,nz,0.1)
tr_2d_vert(e4,e2,30,nz,0.1)
tr_2d_vert(e4,e3,30,nz,0.1)
tr_2d_vert(e4,e4,30,nz,0.1)

```
```{r}
par(mfrow=c(3,3))
tr_2d_vert(e1,e1,30,nz,0.1)
tr_2d_vert(e1,e2,30,nz,0.1)
tr_2d_vert(e1,e3,30,nz,0.1)
tr_2d_vert(e2,e1,30,nz,0.1)
tr_2d_vert(e2,e2,30,nz,0.1)
tr_2d_vert(e2,e3,30,nz,0.1)
tr_2d_vert(e3,e1,30,nz,0.1)
tr_2d_vert(e3,e2,30,nz,0.1)
tr_2d_vert(e3,e3,30,nz,0.1)
```

the diagenetic facies
```{r, fig.height=8, fig.width=8}
par(mfrow=c(3,3))
tr_2d_vert(d1,d1,30,nz,0.1)
tr_2d_vert(d1,d2,30,nz,0.1)
tr_2d_vert(d1,d3,30,nz,0.1)
tr_2d_vert(d2,d1,30,nz,0.1)
tr_2d_vert(d2,d2,30,nz,0.1)
tr_2d_vert(d2,d3,30,nz,0.1)
tr_2d_vert(d3,d1,30,nz,0.1)
tr_2d_vert(d3,d2,30,nz,0.1)
tr_2d_vert(d3,d3,30,nz,0.1)
```

cross-correlations between depositional and diagenetic facies
```{r, fig.height=8, fig.width=8}
par(mfrow=c(4,3))
tr_2d_vert(e1,d1,30,nz,0.1)
tr_2d_vert(e1,d2,30,nz,0.1)
tr_2d_vert(e1,d3,30,nz,0.1)
tr_2d_vert(e2,d1,30,nz,0.1)
tr_2d_vert(e2,d2,30,nz,0.1)
tr_2d_vert(e2,d3,30,nz,0.1)
tr_2d_vert(e3,d1,30,nz,0.1)
tr_2d_vert(e3,d2,30,nz,0.1)
tr_2d_vert(e3,d3,30,nz,0.1)
tr_2d_vert(e4,d1,30,nz,0.1)
tr_2d_vert(e4,d2,30,nz,0.1)
tr_2d_vert(e4,d3,30,nz,0.1)
```

```{r, fig.height=8, fig.width=8}
par(mfrow=c(3,4))
tr_2d_vert(d1,e1,30,nz,0.1)
tr_2d_vert(d1,e2,30,nz,0.1)
tr_2d_vert(d1,e3,30,nz,0.1)
tr_2d_vert(d1,e4,30,nz,0.1)
tr_2d_vert(d2,e1,30,nz,0.1)
tr_2d_vert(d2,e2,30,nz,0.1)
tr_2d_vert(d2,e3,30,nz,0.1)
tr_2d_vert(d2,e4,30,nz,0.1)
tr_2d_vert(d3,e1,30,nz,0.1)
tr_2d_vert(d3,e2,30,nz,0.1)
tr_2d_vert(d3,e3,30,nz,0.1)
tr_2d_vert(d3,e4,30,nz,0.1)
```

ok now we can try to fit a model to these transiograms
first the environment of depositions
we get their proportions

```{r}
pe1 = mean(e1,na.rm=TRUE)
pe2 = mean(e2,na.rm=TRUE)
pe3 = mean(e3,na.rm=TRUE)
pe4 = mean(e4,na.rm=TRUE)
c(pe1,pe2,pe3,pe4)
```

```{r}
library(mvtnorm)
```

model used for the covariances
```{r}
model1<-function(h,range,b){return(exp(-(h/range)^2)*cos(b*h))}
```
fitting 
```{r}
rv1=0.3
rv2=0.5
rhx1=40
rhx2=40
b1=0
b2=0
rho=0.8
shift=0.1
rho1a<-model1(shift,rv1,b1)
alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
#thresholds
q1=qnorm(pe1+pe2)
Sigma1 = matrix(c(1,rho,rho,1),2,2)
q2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(-Inf,-Inf),upper=c(q1,q2test),mean=c(0,0),sigma=Sigma1) - pe1 ) 
  if (newobj < obj){
    q2 = q2test
    obj = newobj
  }
}
q3=0
obj = Inf
for ( test in 1:100 ){
  q3test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(q1,-Inf),upper=c(Inf,q3test),mean=c(0,0),sigma=Sigma1) - pe4 ) 
  if (newobj < obj){
    q3 = q3test
    obj = newobj
  }
}

c(q1,q2,q3)

#transiograms
z = (1:300)/100.
t11_model=t12_model=t13_model=t21_model=t22_model=t23_model=t31_model=t32_model=t33_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]= Sigma[3,4]=Sigma[4,3]=rho
    Sigma[1,3]=Sigma[3,1]=model1(d,rv1,b1)
    Sigma[1,4]=Sigma[4,1]=(rho/rho1a)*model1(abs(d+shift),rv1,b1)
    Sigma[2,3]=Sigma[3,2]=(rho/rho1a)*model1(abs(d-shift),rv1,b1)
    Sigma[2,4]=Sigma[4,2]=alpha1*model1(d,rv1,b1)+alpha2*model1(d,rv2,b2)
    t11_model[i]=pmvnorm(lower=c(-Inf,-Inf,-Inf,-Inf),upper=c(q1,q2,q1,q2),mean=c(0,0,0,0),sigma=Sigma)/ pe1 
    t12_model[i]=pmvnorm(lower=c(-Inf,-Inf,-Inf,q2),upper=c(q1,q2,q1,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pe1 
    t13_model[i]=pmvnorm(lower=c(-Inf,-Inf,q1,q3),upper=c(q1,q2,Inf,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pe1 
    t21_model[i]=pmvnorm(lower=c(-Inf,q2,-Inf,-Inf),upper=c(q1,Inf,q1,q2),mean=c(0,0,0,0),sigma=Sigma)/ pe2
    t22_model[i]=pmvnorm(lower=c(-Inf,q2,-Inf,q2),upper=c(q1,Inf,q1,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pe2
    t23_model[i]=pmvnorm(lower=c(-Inf,q2,q1,q3),upper=c(q1,Inf,Inf,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pe2
    t31_model[i]=pmvnorm(lower=c(q1,q3,-Inf,-Inf),upper=c(Inf,Inf,q1,q2),mean=c(0,0,0,0),sigma=Sigma)/ pe3
    t32_model[i]=pmvnorm(lower=c(q1,q3,-Inf,q2),upper=c(Inf,Inf,q1,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pe3
    t33_model[i]=pmvnorm(lower=c(q1,q3,q1,q3),upper=c(Inf,Inf,Inf,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pe3
}
par(mfrow=c(3,3))
t11<-tr_2d_vert(e1,e1,30,nz,0.1)
lines(z,t11_model)
t12<-tr_2d_vert(e1,e2,30,nz,0.1)
lines(z,t12_model)
t13<-tr_2d_vert(e1,e3,30,nz,0.1)
lines(z,t13_model)
t21<-tr_2d_vert(e2,e1,30,nz,0.1)
lines(z,t21_model)
t22<-tr_2d_vert(e2,e2,30,nz,0.1)
lines(z,t22_model)
t23<-tr_2d_vert(e2,e3,30,nz,0.1)
lines(z,t23_model)
t31<-tr_2d_vert(e3,e1,30,nz,0.1)
lines(z,t31_model)
t32<-tr_2d_vert(e3,e2,30,nz,0.1)
lines(z,t32_model)
t33<-tr_2d_vert(e3,e3,30,nz,0.1)
lines(z,t33_model)
```

ok now we can look at the diagenetic facies
their proportions

```{r}
pd1=mean(d1,na.rm=TRUE)
pd2=mean(d2,na.rm=TRUE)
pd3=mean(d3,na.rm=TRUE)
c(pd1,pd2,pd3)
```
now the transiograms
```{r}
rv3=0.2
rv4=0.3
rhx3=40
rhx4=40
b3=0
b4=0
rho34=0.

#thresholds
qd1=qnorm(pd3)
Sigma1 = matrix(c(1,rho34,rho34,1),2,2)
qd2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(qd1,q2test),upper=c(Inf,Inf),mean=c(0,0),sigma=Sigma1) - pd2 ) 
  if (newobj < obj){
    qd2 = q2test
    obj = newobj
  }
}

c(qd1,qd2)

#transiograms

z = (1:300)/100.
t33d_model=t32d_model=t23d_model=t22d_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]= Sigma[3,4]=Sigma[4,3]=rho34
    Sigma[1,3]=Sigma[3,1]=model1(d,rv3,b3)
    Sigma[1,4]=Sigma[4,1]=Sigma[2,3]=Sigma[3,2]=rho34*model1(d,rv3,b3)
    Sigma[2,4]=Sigma[4,2]=(rho34^2)*model1(d,rv3,b3)+(1-rho34^2)*model1(d,rv4,b4)

    t22d_model[i]=pmvnorm(lower=c(qd1,qd2,qd1,qd2),upper=c(Inf,Inf,Inf,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pd2
    t23d_model[i]=pmvnorm(lower=c(qd1,qd2,-Inf,-Inf),upper=c(Inf,Inf,qd1,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pd2
    t32d_model[i]=pmvnorm(lower=c(-Inf,-Inf,qd1,qd2),upper=c(qd1,Inf,Inf,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pd3
    t33d_model[i]=pmvnorm(lower=c(-Inf,-Inf,-Inf,-Inf),upper=c(qd1,Inf,qd1,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pd3
}
par(mfrow=c(2,2))
t22d<-tr_2d_vert(d2,d2,30,nz,0.1)
lines(z,t22d_model)
t23d<-tr_2d_vert(d2,d3,30,nz,0.1)
lines(z,t23d_model)
t32d<-tr_2d_vert(d3,d2,30,nz,0.1)
lines(z,t32d_model)
t33d<-tr_2d_vert(d3,d3,30,nz,0.1)
lines(z,t33d_model)
```

Let's now do a more complex case study, where the four Gaussian functions are correlated. 
Z1 =Y1
Z2 = a Y1(x+a12) + b Y2(x)
Z3 = c Y1(x+a13) + d Y3(x)
Z4 = e Y1(x+a14) + f Y4(x)
```{r}
rv1=0.3
rv2=0.5
rhx1=40
rhx2=40
b1=0
b2=0
rho=0.8
shift=0.1
rho1a<-model(shift,rv1,b1)

alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
rv3=0.2
rv4=0.3
rhx3=40
rhx4=40
b3=0
b4=0
rho34=0.
c=0.
e=0.65
a13=-0.
a14=-0.1
rho1a14 = model1(a14,rv1,b1)
#thresholds of environment of depositions, do not depend on diagenesis functions
q1=qnorm(pe1+pe2)
Sigma1 = matrix(c(1,rho,rho,1),2,2)
q2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(-Inf,-Inf),upper=c(q1,q2test),mean=c(0,0),sigma=Sigma1) - pe1 ) 
  if (newobj < obj){
    q2 = q2test
    obj = newobj
  }
}
q3=0
obj = Inf
for ( test in 1:100 ){
  q3test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(q1,-Inf),upper=c(Inf,q3test),mean=c(0,0),sigma=Sigma1) - pe4 ) 
  if (newobj < obj){
    q3 = q3test
    obj = newobj
  }
}

# thresholds of diagenesis
qd1=qnorm(pd3)
Sigma1 = matrix(c(1,rho34,rho34,1),2,2)
qd2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(qd1,q2test),upper=c(Inf,Inf),mean=c(0,0),sigma=Sigma1) - pd2 ) 
  if (newobj < obj){
    qd2 = q2test
    obj = newobj
  }
}

c(qd1,qd2)

#now we can look at the transition probabilities between half dolomite and subaerial exposure
z = (1:300)/100.
td2e4_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]=rho34
    Sigma[1,3]=Sigma[3,1]=c*model1(d-a13,rv1,b1)
    Sigma[1,4]=Sigma[4,1]=c*(rho/rho1a)*model1(a13-d-shift,rv1,b1)
    Sigma[2,3]=Sigma[3,2]=e*model1(a14-d,rv1,b1)
    Sigma[2,4]=Sigma[4,2]=e*(rho/rho1a)*model1(a14-d-shift,rv1,b1)
    Sigma[3,4]=Sigma[4,3]=rho

    td2e4_model[i]=pmvnorm(lower=c(qd1,qd2,q1,-Inf),upper=c(Inf,Inf,Inf,q3),mean=c(0,0,0,0),sigma=Sigma)/ pd2
}

tr_2d_vert(d2,e4,30,nz,0.1)
lines(z,td2e4_model)
```
looking at different cases
```{r}
e=0.0
a14=-0.
z = (1:300)/100.
td2e4_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]=rho34
    Sigma[1,3]=Sigma[3,1]=c*model1(d-a13,rv1,b1)
    Sigma[1,4]=Sigma[4,1]=c*(rho/rho1a)*model1(a13-d-shift,rv1,b1)
    Sigma[2,3]=Sigma[3,2]=e*model1(a14-d,rv1,b1)
    Sigma[2,4]=Sigma[4,2]=e*(rho/rho1a)*model1(a14-d-shift,rv1,b1)
    Sigma[3,4]=Sigma[4,3]=rho

    td2e4_model[i]=pmvnorm(lower=c(qd1,qd2,q1,-Inf),upper=c(Inf,Inf,Inf,q3),mean=c(0,0,0,0),sigma=Sigma)/ pd2
}

tr_2d_vert(d2,e4,30,nz,0.1)
lines(z,td2e4_model)

e=0.7
a14=-0.

td2e4_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]=rho34
    Sigma[1,3]=Sigma[3,1]=c*model1(d-a13,rv1,b1)
    Sigma[1,4]=Sigma[4,1]=c*(rho/rho1a)*model1(a13-d-shift,rv1,b1)
    Sigma[2,3]=Sigma[3,2]=e*model1(a14-d,rv1,b1)
    Sigma[2,4]=Sigma[4,2]=e*(rho/rho1a)*model1(a14-d-shift,rv1,b1)
    Sigma[3,4]=Sigma[4,3]=rho

    td2e4_model[i]=pmvnorm(lower=c(qd1,qd2,q1,-Inf),upper=c(Inf,Inf,Inf,q3),mean=c(0,0,0,0),sigma=Sigma)/ pd2
}
tr_2d_vert(d2,e4,30,nz,0.1)
lines(z,td2e4_model) 

e=0.7
a14=-0.1
td2e4_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]=rho34
    Sigma[1,3]=Sigma[3,1]=c*model1(d-a13,rv1,b1)
    Sigma[1,4]=Sigma[4,1]=c*(rho/rho1a)*model1(a13-d-shift,rv1,b1)
    Sigma[2,3]=Sigma[3,2]=e*model1(a14-d,rv1,b1)
    Sigma[2,4]=Sigma[4,2]=e*(rho/rho1a)*model1(a14-d-shift,rv1,b1)
    Sigma[3,4]=Sigma[4,3]=rho

    td2e4_model[i]=pmvnorm(lower=c(qd1,qd2,q1,-Inf),upper=c(Inf,Inf,Inf,q3),mean=c(0,0,0,0),sigma=Sigma)/ pd2
}
tr_2d_vert(d2,e4,30,nz,0.1)
lines(z,td2e4_model) 
```
```{r}
rv1=0.3
rv2=0.5
rhx1=40
rhx2=40
b1=20
b2=0
rho=0.8
shift=0.1
rho1a<-model1(shift,rv1,b1)

alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
rv3=0.2
rv4=0.3
rhx3=40
rhx4=40
b3=0
b4=0
rho34=0.
c=-0.
e=-0.65
a13=0.
a14=-0.1
rho1a14 = model1(a14,rv1,b1)
#thresholds of environment of depositions, do not depend on diagenesis functions
q1=qnorm(pe1+pe2)
Sigma1 = matrix(c(1,rho,rho,1),2,2)
q2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(-Inf,-Inf),upper=c(q1,q2test),mean=c(0,0),sigma=Sigma1) - pe1 ) 
  if (newobj < obj){
    q2 = q2test
    obj = newobj
  }
}
q3=0
obj = Inf
for ( test in 1:100 ){
  q3test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(q1,-Inf),upper=c(Inf,q3test),mean=c(0,0),sigma=Sigma1) - pe4 ) 
  if (newobj < obj){
    q3 = q3test
    obj = newobj
  }
}

# thresholds of diagenesis
qd1=qnorm(pd3)
Sigma1 = matrix(c(1,rho34,rho34,1),2,2)
qd2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(qd1,q2test),upper=c(Inf,Inf),mean=c(0,0),sigma=Sigma1) - pd2 ) 
  if (newobj < obj){
    qd2 = q2test
    obj = newobj
  }
}

c(qd1,qd2)

#now we can look at the transition probabilities between half dolomite and subaerial exposure
z = (1:300)/100.
td2e2_model=rep(0,300)
Sigma = diag(1,4)
for (i in 1:300){
    d = i/100.
    Sigma[1,2]=Sigma[2,1]=rho34
    Sigma[1,3]=Sigma[3,1]=c*model1(d-a13,rv1,b1)
    Sigma[1,4]=Sigma[4,1]=c*(rho/rho1a)*model1(a13-d-shift,rv1,b1)
    Sigma[2,3]=Sigma[3,2]=e*model1(a14-d,rv1,b1)
    Sigma[2,4]=Sigma[4,2]=e*(rho/rho1a)*model1(a14-d-shift,rv1,b1)
    Sigma[3,4]=Sigma[4,3]=rho

    td2e2_model[i]=pmvnorm(lower=c(qd1,qd2,-Inf,q2),upper=c(Inf,Inf,q1,Inf),mean=c(0,0,0,0),sigma=Sigma)/ pd2
}

tr_2d_vert(d2,e2,30,nz,0.1)
lines(z,td2e2_model)
```


The proportions of diagenetic facies conditional to the environment of depositions
this will be useful for the simulation
```{r}
pd1e1=mean(d1*e1,na.rm=TRUE)/pe1
pd1e2=mean(d1*e2,na.rm=TRUE)/pe2
pd1e3=mean(d1*e3,na.rm=TRUE)/pe3
pd1e4=mean(d1*e4,na.rm=TRUE)/pe4

pd2e1=mean(d2*e1,na.rm=TRUE)/pe1
pd2e2=mean(d2*e2,na.rm=TRUE)/pe2
pd2e3=mean(d2*e3,na.rm=TRUE)/pe3
pd2e4=mean(d2*e4,na.rm=TRUE)/pe4

pd3e1=mean(d3*e1,na.rm=TRUE)/pe1
pd3e2=mean(d3*e2,na.rm=TRUE)/pe2
pd3e3=mean(d3*e3,na.rm=TRUE)/pe3
pd3e4=mean(d3*e4,na.rm=TRUE)/pe4

matrix(c(pd1e1,pd1e2,pd1e3,pd1e4,pd2e1,pd2e2,pd2e3,pd2e4,pd3e1,pd3e2,pd3e3,pd3e4),3,4,byrow=TRUE)

```

all these proportions should result in thresholds for the different facies (there are 3 thresholds to compute)
```{r}
qd1e4=qnorm(pd3e4)
qd2e2=qnorm(pd1e2) # i am not sure this is true if there is a correlation between fourth and first Gaussian function
qd2e3=qnorm(pd1e3)
```
now we can perform the simulation

```{r}
#gaussian simulation
rhx3=80
rhx4=80
rhx1=80
rhx2=80
Z1<-sim2d(rv1,rhx1,b1,100,0.05,182,0.5,200)
Y2<-sim2d(rv2,rhx2,b2,100,0.05,182,0.5,200)
Z2=Y2
for ( z in 1:180){
  Z2[,z]=Y2[,z]*sqrt(1-(rho^2)/(rho1a^2))+Z1[,z+2]*(rho)/(rho1a)
}
Z3<-sim2d(rv3,rhx3,b3,100,0.05,182,0.5,200)
Z4<-sim2d(rv4,rhx4,b4,100,0.05,182,0.5,200)

# truncation
faciesenv<-faciesdiag<-Z1
faciesenv[Z1<q1 & Z2<q2]=1
faciesenv[Z1<q1 & Z2>q2]=2
faciesenv[Z1>q1 & Z2<q3]=4
faciesenv[Z1>q1 & Z2>q3]=3
faciesdiag[]=1
faciesdiag[Z1>q1 & Z2<q3 & Z3<qd1e4]=3
faciesdiag[Z1<q1 & Z2>q2 & Z4>qd2e2]=2
faciesdiag[Z1>q1 & Z2>q3 & Z4>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
col_diag<-dcolors <- c("black","grey","yellow")
image(faciesenv,col = col_env)
image(faciesdiag,col = col_diag)
```

now we would like to do a view with both facies fields on the same image
```{r}
bin<-bin2<-faciesenv
#bin[]<-rbinom(91*100, 1, 0.5)
bin[]=bin2[]=0
bin[seq(2,182*200,by=2)]=1
facies=faciesenv
facies[faciesdiag==2 & bin ==1 ] = 5
facies[faciesdiag==3]=5

col_combine <- c("lightgreen","cadetblue","dodgerblue4","lightcoral","yellow")
W<-image(facies,col = col_combine)
```

now we want to perform a simulation with correlation between Z1 and Z4 and shift
so that the facies 50 dol is below the subaerial exposure facies

first we need to re-compute the thresholds

```{r}
rv1=0.3
rv2=0.5
rhx1=40
rhx2=40
b1=0
b2=0
rho=0.8
shift=0.1
rho1a<-model1(shift,rv1,b1)

alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
rv3=0.2
rv4=0.3
rhx3=40
rhx4=40
b3=0
b4=0
rho34=0.
c=0.
e=0.65
a13=-0.
a14=-0.1
rho1a14 = model1(a14,rv1,b1)

# this one does not change because no correlation of the third gaussian function
qd1e4=qnorm(pd3e4) 

# now the threshold with the fourth Gaussian function, that does depend on the first
sigma1=diag(1,3)
sigma1[1,2]=sigma1[2,1]=e*model1(a14,rv1,b1)
sigma1[1,3]=sigma1[3,1]=e*(rho/rho1a)*model1(a14-shift,rv1,b1)
sigma1[2,3]=sigma1[3,2]=rho

qd2e2=0
obj = Inf
for ( test in 1:100 ){
  qd2e2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(qd2e2test,-Inf,q2),upper=c(Inf,q1,Inf),mean=c(0,0,0),sigma=sigma1)/pe2 - pd2e2 ) 
  if (newobj < obj){
    qd2e2 = qd2e2test
    obj = newobj
  }
}

qd2e3=0
obj = Inf
for ( test in 1:100 ){
  qd2e3test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(qd2e3test,q1,q3),upper=c(Inf,Inf,Inf),mean=c(0,0,0),sigma=sigma1)/pe3 - pd2e3 ) 
  if (newobj < obj){
    qd2e3 = qd2e3test
    obj = newobj
  }
}

print(c(qd1e4,qd2e2,qd2e3))
```

Okay, we may now perform the simulation

```{r}
Z1<-sim2d(rv1,rhx1,b1,100,0.05,182,0.5,200)
Y2<-sim2d(rv2,rhx2,b2,100,0.05,182,0.5,200)
Z2=Y2
for ( z in 1:180){
  Z2[,z]=Y2[,z]*sqrt(1-(rho^2)/(rho1a^2))+Z1[,z+2]*(rho)/(rho1a)
}
Z3<-sim2d(rv3,rhx3,b3,100,0.05,182,0.5,200)
Y4<-sim2d(rv4,rhx4,b4,100,0.05,182,0.5,200)
for ( z in 2:182){
  Z4[,z]=Y4[,z]*sqrt(1-e^2)+Z1[,z-1]*e
}

# truncation
faciesenv<-faciesdiag<-Z1
faciesenv[Z1<q1 & Z2<q2]=1
faciesenv[Z1<q1 & Z2>q2]=2
faciesenv[Z1>q1 & Z2<q3]=4
faciesenv[Z1>q1 & Z2>q3]=3
faciesdiag[]=1
faciesdiag[Z1>q1 & Z2<q3 & Z3<qd1e4]=3
faciesdiag[Z1<q1 & Z2>q2 & Z4>qd2e2]=2
faciesdiag[Z1>q1 & Z2>q3 & Z4>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
col_diag<-dcolors <- c("black","grey","yellow")
image(faciesenv,col = col_env)
image(faciesdiag,col = col_diag)

```
```{r}
bin<-bin2<-faciesenv
#bin[]<-rbinom(91*100, 1, 0.5)
bin[]=bin2[]=0
bin[seq(2,182*200,by=2)]=1
facies=faciesenv
facies[faciesdiag==2 & bin ==1 ] = 5
facies[faciesdiag==3]=5

col_combine <- c("lightgreen","cadetblue","dodgerblue4","lightcoral","yellow")
W<-image(facies,col = col_combine)
```

```{r}
for ( z in 1:181){
  Z4[,z]=Y4[,z]*sqrt(1-e^2)+Z1[,z+1]*e
}

faciesenv<-faciesdiag<-Z1
faciesenv[Z1<q1 & Z2<q2]=1
faciesenv[Z1<q1 & Z2>q2]=2
faciesenv[Z1>q1 & Z2<q3]=4
faciesenv[Z1>q1 & Z2>q3]=3
faciesdiag[]=1
faciesdiag[Z1>q1 & Z2<q3 & Z3<qd1e4]=3
faciesdiag[Z1<q1 & Z2>q2 & Z4>qd2e2]=2
faciesdiag[Z1>q1 & Z2>q3 & Z4>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
col_diag<-dcolors <- c("black","grey","yellow")
image(faciesenv,col = col_env)
image(faciesdiag,col = col_diag)
bin<-bin2<-faciesenv
#bin[]<-rbinom(91*100, 1, 0.5)
bin[]=bin2[]=0
bin[seq(2,182*200,by=2)]=1
facies=faciesenv
facies[faciesdiag==2 & bin ==1 ] = 5
facies[faciesdiag==3]=5

col_combine <- c("lightgreen","cadetblue","dodgerblue4","lightcoral","yellow")
W<-image(facies,col = col_combine)
```

I would like to try the conditioning now for the co-simulation

```{r}
source("co_sim_condi.R")
```


```{r}
grid<-grid_co<-array(NA,c(100,91))
grid[5,]<-env_lat[,1]
grid[25,]<-env_lat[,2]
grid[35,]<-env_lat[,3]
grid[95,]<-env_lat[,4]
grid_co[5,]<-diag_lat[,1]
grid_co[25,]<-diag_lat[,2]
grid_co[35,]<-diag_lat[,3]
grid_co[95,]<-diag_lat[,4]
image(grid)
image(grid_co)
simwell<-coco_gibbs_sampling(grid,grid_co,c(q1,q2,q3),c(qd1e4,qd2e2,qd2e3),0.1,1,c(rv1,rv2,rv3,rv4),c(rhx1,rhx2,rhx3,rhx4),c(b1,b2,b3,b4),c(rho,e*model1(a14,rv1,b1)),c(shift,a14),5)
Z1<-simwell[,1:91]
Z2<-simwell[,92:182]
Z3<-simwell[,183:273]
Z4<-simwell[,274:364]
image(Z1)
faciesenv<-faciesdiag<-Z1
faciesenv[Z1<q1 & Z2<q2]=1
faciesenv[Z1<q1 & Z2>q2]=2
faciesenv[Z1>q1 & Z2<q3]=4
faciesenv[Z1>q1 & Z2>q3]=3
faciesdiag[]=NA
faciesdiag[3,]=faciesdiag[20,]=faciesdiag[55,]=faciesdiag[80,]=1
faciesdiag[Z1>q1 & Z2<q3 & Z3<qd1e4]=3
faciesdiag[Z1<q1 & Z2>q2 & Z4>qd2e2]=2
faciesdiag[Z1>q1 & Z2>q3 & Z4>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
col_diag<-dcolors <- c("black","grey","yellow")
image(grid,col = col_env)
image(faciesenv,col = col_env)
image(faciesdiag,col = col_diag)
image(grid_co,col = col_diag)
```

```{r}
source("co_sim_condi.R")
```


totalsimu
```{r}
rv1=0.3
rv2=0.5
rhx1=50
rhx2=50
b1=0
b2=0
rho=0.8
shift=0.1
rho1a<-model1(shift,rv1,b1)

alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
rv3=0.2
rv4=0.3
rhx3=50
rhx4=50
b3=0
b4=0
rho34=0.
c=0.
e=0.65
a13=-0.
a14=-0.1
rho1a14 = model1(a14,rv1,b1)

Z1<-sim2d(rv1,rhx1,b1,100,0.1,91,1,100)
Y2<-sim2d(rv2,rhx2,b2,100,0.1,91,1,100)
Z2=Y2
for ( z in 1:90){
  Z2[,z]=Y2[,z]*sqrt(1-(rho^2)/(rho1a^2))+Z1[,z+1]*(rho)/(rho1a)
}
Z3<-sim2d(rv3,rhx3,b3,100,0.1,91,1,100)
Y4<-sim2d(rv4,rhx4,b4,100,0.1,91,1,100)
for ( z in 2:91){
  Z4[,z]=Y4[,z]*sqrt(1-e^2)+Z1[,z-1]*e
}
#grid<-grid_co<-array(NA,c(100,91))
#grid[3,]<-env_lat[,1]
#grid_co[3,]<-diag_lat[,1]


simwell<-coco_gibbs_sampling(grid,grid_co,c(q1,q2,q3),c(qd1e4,qd2e2,qd2e3),0.1,1,c(rv1,rv2,rv3,rv4),c(rhx1,rhx2,rhx3,rhx4),c(b1,b2,b3,b4),c(rho,e*model1(a14,rv1,b1)),c(shift,a14),10)
Z1well<-simwell[,1:91]
Z2well<-simwell[,92:182]
Z3well<-simwell[,183:273]
Z4well<-simwell[,274:364]
```


now the kriging
```{r}
#rv1=rv2=rv3=rv4 = 0.1
#rhx1=rhx2=rhx3=rhx4=1
#b1=b2=b3=b4=0
#rho=e=0.0
#shift=a14=0.0
E<-coco_dual_krig(Z1well-Z1,Z2well-Z2,Z3well-Z3,Z4well-Z4,0.1,1,c(rv1,rv2,rv3,rv4),c(rhx1,rhx2,rhx3,rhx4),c(b1,b2,b3,b4),c(rho,e*model1(a14,rv1,b1)),c(shift,a14))
Z1c=Z1 + E[,1:91]
Z2c<-Z2 +E[,92:182]
Z3c<-Z3 +E[,183:273]
Z4c<-Z4 +E[,274:364]

faciesenv<-faciesdiag<-Z1c
faciesenv[Z1c<q1 & Z2c<q2]=1
faciesenv[Z1c<q1 & Z2c>q2]=2
faciesenv[Z1c>q1 & Z2c<q3]=4
faciesenv[Z1c>q1 & Z2c>q3]=3
faciesdiag[]=1
faciesdiag[Z1c>q1 & Z2c<q3 & Z3c<qd1e4]=3
faciesdiag[Z1c<q1 & Z2c>q2 & Z4c>qd2e2]=2
faciesdiag[Z1c>q1 & Z2c>q3 & Z4c>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
W<-image(faciesenv,col = col_env)
bin<-bin2<-faciesenv
#bin[]<-rbinom(91*100, 1, 0.5)
bin[]=bin2[]=0
bin[seq(2,91*100,by=2)]=1
facies=faciesenv
facies[faciesdiag==2 & bin ==1 ] = 5
facies[faciesdiag==3]=5

col_combine <- c("lightgreen","cadetblue","dodgerblue4","lightcoral","yellow")
W<-image(facies,col = col_combine)
image(Z1c)
```

trying simulation with noise
```{r}
source("co_sim_condi.R")
```

```{r}
model<-function(h,range,b){return(exp(-abs(h/range))*cos(b*h) )}
model_lat<-function(h,range){return(exp(-(h/range)^2) )}
```
```{r}
rv1=0.3
rv2=1.2
rhx1=40
rhx2=40
b1=0
b2=5
rho=0.6
shift=0.1
rho1a<-model(shift,rv1,b1)
warning(rho>rho1a)
alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
rv3=0.2
rv4=0.3
rhx3=40
rhx4=40
b3=0
b4=0
e=-0.8
f=-0.5

a14=-0.1
a24=0.1
rho1a14 = model(a14,rv1,b1)
rho2a24=model(a24,rv2,b2)

q1=qnorm(pe1+pe2)
Sigma1 = matrix(c(1,rho,rho,1),2,2)
q2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(-Inf,-Inf),upper=c(q1,q2test),mean=c(0,0),sigma=Sigma1) - pe1 ) 
  if (newobj < obj){
    q2 = q2test
    obj = newobj
  }
}
q3=0
obj = Inf
for ( test in 1:100 ){
  q3test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(q1,-Inf),upper=c(Inf,q3test),mean=c(0,0),sigma=Sigma1) - pe4 ) 
  if (newobj < obj){
    q3 = q3test
    obj = newobj
  }
}

c(q1,q2,q3)

qd1e4=qnorm(pd3e4) # no correlation with the third Gaussian function
Sigmad = diag(1,3)
qd2e2=0
qd2e3=0
obje2 = Inf
obje3 = Inf
for ( test in 1:100 ){
  qd2e2test = qnorm(test/100)
  qd2e3test = qnorm(test/100)
  Sigmad[1,2]=Sigmad[2,1]=e*rho1a14
  Sigmad[1,3]=Sigmad[3,1]=e*(rho/rho1a)*model(a14-shift,rv1,b1)+f*sqrt(1-(rho/rho1a)^2)*model(a24,rv2,b2)
  Sigmad[2,3]=Sigmad[3,2]=rho
  newobje2 =abs( pmvnorm(lower=c(qd2e2test,-Inf,q2),upper=c(Inf,q1,Inf),mean=c(0,0,0),sigma=Sigmad)/pe2 - pd2e2 ) 
  newobje3 =abs( pmvnorm(lower=c(qd2e3test,q1,q3),upper=c(Inf,Inf,Inf),mean=c(0,0,0),sigma=Sigmad)/pe3 - pd2e3 )
  if (newobje2 < obje2){
    qd2e2 = qd2e2test
    obje2 = newobje2
  }
  if (newobje3 < obje3){
    qd2e3 = qd2e3test
    obje3 = newobje3
  }
}

c(qd1e4,qd2e2,qd2e3)

Z1<-sim2dexp(rv1,rhx1,b1,100,0.1,91,1,100)
Y2<-sim2dexp(rv2,rhx2,b2,100,0.1,91,1,100)
Z2=Y2
for ( z in 1:90){
  Z2[,z]=Y2[,z]*sqrt(1-(rho^2)/(rho1a^2))+Z1[,z+1]*(rho)/(rho1a)
}
Z3<-sim2dexp(rv3,rhx3,b3,100,0.1,91,1,100)
Y4<-sim2dexp(rv4,rhx4,b4,100,0.1,91,1,100)
Z4=Y4
for ( z in 2:90){
  Z4[,z]=Y4[,z]*sqrt(1-(e^2)-(f^2))+Z1[,z-1]*e+f*Y2[,z+1]
}
#grid<-grid_co<-array(NA,c(100,91))
#grid[3,]<-env_lat[,1]
#grid_co[3,]<-diag_lat[,1]


simwell<-coco_gibbs_sampling(grid,grid_co,c(q1,q2,q3),c(qd1e4,qd2e2,qd2e3),0.1,1,c(rv1,rv2,rv3,rv4),c(rhx1,rhx2,rhx3,rhx4),c(b1,b2,b3,b4),c(rho,e*model(a14,rv1,b1),f*model(a24,rv2,b2)),c(shift,a14,a24),50)
Z1well<-simwell[,1:91]
Z2well<-simwell[,92:182]
Z3well<-simwell[,183:273]
Z4well<-simwell[,274:364]

E<-coco_dual_krig(Z1well-Z1,Z2well-Z2,Z3well-Z3,Z4well-Z4,0.1,1,c(rv1,rv2,rv3,rv4),c(rhx1,rhx2,rhx3,rhx4),c(b1,b2,b3,b4),c(rho,e*model(a14,rv1,b1),f*model(a24,rv2,b2)),c(shift,a14,a24))
Z1c=Z1 + E[,1:91]
Z2c<-Z2 +E[,92:182]
Z3c<-Z3 +E[,183:273]
Z4c<-Z4 +E[,274:364]

faciesenv<-faciesdiag<-Z1c
faciesenv[Z1c<q1 & Z2c<q2]=1
faciesenv[Z1c<q1 & Z2c>q2]=2
faciesenv[Z1c>q1 & Z2c<q3]=4
faciesenv[Z1c>q1 & Z2c>q3]=3
faciesdiag[]=1
faciesdiag[Z1c>q1 & Z2c<q3 & Z3c<qd1e4]=3
faciesdiag[Z1c<q1 & Z2c>q2 & Z4c>qd2e2]=2
faciesdiag[Z1c>q1 & Z2c>q3 & Z4c>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
W<-image(faciesenv,col = col_env)
bin<-bin2<-faciesenv
#bin[]<-rbinom(91*100, 1, 0.5)
bin[]=bin2[]=0
bin[seq(2,91*100,by=2)]=1
facies=faciesenv
facies[faciesdiag==2 & bin ==1 ] = 5
facies[faciesdiag==3]=5

col_combine <- c("lightgreen","cadetblue","dodgerblue4","lightcoral","yellow")
W<-image(facies,col = col_combine)
```

ok we have seen that the co-kriging creates a singular matrix. 
Therefore, for the kriging step we back transform the Zi on the wells in Yi and we perform the kriging on the Yi. Finally, the Yi realization is transformed into Zi. 
The advantage of that method is that because we use the Yi, they are separable. 
Therefore there is no kriging on the vertical direction and a Gaussian cosine can therefore be used! 

```{r}
source("co_sim_condi.R")
```
```{r}
library(mvtnorm)
```

```{r}
model<-function(h,range,b){return(exp(-abs(h/range)^2)*cos(b*h) )}
model_lat<-function(h,range){return(exp(-(h/range)^2) )}
```

```{r}
env_lat[is.na(env_lat)]=0 # with 0, the gibbs sampler will find random values
diag_lat[is.na(diag_lat)]=0
grid<-grid_co<-array(NA,c(100,91))
grid[5,]<-env_lat[,1]
grid[25,]<-env_lat[,2]
grid[35,]<-env_lat[,3]
grid[95,]<-env_lat[,4]
grid_co[5,]<-diag_lat[,1]
grid_co[25,]<-diag_lat[,2]
grid_co[35,]<-diag_lat[,3]
grid_co[95,]<-diag_lat[,4]

```


```{r}
#parameters
rv1=0.3
rv2=1.2
rhx1=40
rhx2=40
b1=0
b2=5
rho=0.6
shift=0.1
rho1a<-model(shift,rv1,b1)
warning(rho>rho1a)
alpha1=(rho/rho1a)^2
alpha2=1-(rho/rho1a)^2
rv3=0.2
rv4=0.3
rhx3=40
rhx4=40
b3=0
b4=0
e=-0.8
f=-0.5
a14=-0.1
a24=0.1
rho1a14 = model(a14,rv1,b1)
rho2a24=model(a24,rv2,b2)

#thresholds
q1=qnorm(pe1+pe2)
Sigma1 = matrix(c(1,rho,rho,1),2,2)
q2=0
obj = Inf
for ( test in 1:100 ){
  q2test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(-Inf,-Inf),upper=c(q1,q2test),mean=c(0,0),sigma=Sigma1) - pe1 ) 
  if (newobj < obj){
    q2 = q2test
    obj = newobj
  }
}
q3=0
obj = Inf
for ( test in 1:100 ){
  q3test = qnorm(test/100)
  newobj =abs( pmvnorm(lower=c(q1,-Inf),upper=c(Inf,q3test),mean=c(0,0),sigma=Sigma1) - pe4 ) 
  if (newobj < obj){
    q3 = q3test
    obj = newobj
  }
}
c(q1,q2,q3)
qd1e4=qnorm(pd3e4) # no correlation with the third Gaussian function
Sigmad = diag(1,3)
qd2e2=0
qd2e3=0
obje2 = Inf
obje3 = Inf
for ( test in 1:100 ){
  qd2e2test = qnorm(test/100)
  qd2e3test = qnorm(test/100)
  Sigmad[1,2]=Sigmad[2,1]=e*rho1a14
  Sigmad[1,3]=Sigmad[3,1]=e*(rho/rho1a)*model(a14-shift,rv1,b1)+f*sqrt(1-(rho/rho1a)^2)*model(a24,rv2,b2)
  Sigmad[2,3]=Sigmad[3,2]=rho
  newobje2 =abs( pmvnorm(lower=c(qd2e2test,-Inf,q2),upper=c(Inf,q1,Inf),mean=c(0,0,0),sigma=Sigmad)/pe2 - pd2e2 ) 
  newobje3 =abs( pmvnorm(lower=c(qd2e3test,q1,q3),upper=c(Inf,Inf,Inf),mean=c(0,0,0),sigma=Sigmad)/pe3 - pd2e3 )
  if (newobje2 < obje2){
    qd2e2 = qd2e2test
    obje2 = newobje2
  }
  if (newobje3 < obje3){
    qd2e3 = qd2e3test
    obje3 = newobje3
  }
}
c(qd1e4,qd2e2,qd2e3)

#unconditioned Yi
Y1<-sim2d(rv1,rhx1,b1,100,0.1,91,1,100)
Y2<-sim2d(rv2,rhx2,b2,100,0.1,91,1,100)
Y3<-sim2d(rv3,rhx3,b3,100,0.1,91,1,100)
Y4<-sim2d(rv4,rhx4,b4,100,0.1,91,1,100)

#conditioned Zi at the wells
simwell<-coco_gibbs_sampling(grid,grid_co,c(q1,q2,q3),c(qd1e4,qd2e2,qd2e3),0.1,1,c(rv1,rv2,rv3,rv4),c(rhx1,rhx2,rhx3,rhx4),c(b1,b2,b3,b4),c(rho,e*model(a14,rv1,b1),f*model(a24,rv2,b2)),c(shift,a14,a24),50)
Y1well<-simwell[,1:91]
Y2well<-Z2well<-simwell[,92:182]
Y3well<-simwell[,183:273]
Y4well<-Z4well<-simwell[,274:364]

# back transformation of the Zi into Yi at the wells
for( z in 2:90){
  Y2well[,z]=(Z2well[,z]-(rho/rho1a)*Y1well[,z+1])/sqrt(1-(rho^2)/(rho1a^2))
  Y4well[,z]=(Z4well[,z]-Y1well[,z-1]*e-f*Y2well[,z+1])/sqrt(1-(e^2)-(f^2))
}

# kriging on the Yi
Z1c =Y1 + dual_krig_line(Y1well-Y1,rhx1,1)
Z2c<-Y2c<-Y2 +dual_krig_line(Y2well-Y2,rhx2,1)
Z3c<-Y3 +dual_krig_line(Y3well-Y3,rhx3,1)
Z4c<-Y4c<-Y4 +dual_krig_line(Y4well-Y4,rhx4,1)

# transforming the conditioned realization Yi into Zi
for( z in 2:90){
  Z2c[,z]=Y2c[,z]*sqrt(1-(rho^2)/(rho1a^2))+Z1c[,z+1]*(rho)/(rho1a)
  Z4c[,z]=Y4c[,z]*sqrt(1-(e^2)-(f^2))+Z1c[,z-1]*e+f*Y2c[,z+1]
}

# transforming the Zi into facies 
faciesenv<-faciesdiag<-Z1c
faciesenv[Z1c<q1 & Z2c<q2]=1
faciesenv[Z1c<q1 & Z2c>q2]=2
faciesenv[Z1c>q1 & Z2c<q3]=4
faciesenv[Z1c>q1 & Z2c>q3]=3
faciesdiag[]=1
faciesdiag[Z1c>q1 & Z2c<q3 & Z3c<qd1e4]=3
faciesdiag[Z1c<q1 & Z2c>q2 & Z4c>qd2e2]=2
faciesdiag[Z1c>q1 & Z2c>q3 & Z4c>qd2e3]=2
col_env <- c("lightgreen","cadetblue","dodgerblue4","lightcoral")
griddata<-grid
griddata[griddata==0]=NA
W<-image(griddata,col = col_env)
W<-image(faciesenv,col = col_env)
bin<-bin2<-faciesenv
#bin[]<-rbinom(91*100, 1, 0.5)
bin[]=bin2[]=0
bin[seq(2,91*100,by=2)]=1
facies=faciesenv
facies[faciesdiag==2 & bin ==1 ] = 5
facies[faciesdiag==3]=5

col_combine <- c("lightgreen","cadetblue","dodgerblue4","lightcoral","yellow")
W<-image(facies,col = col_combine)
```

